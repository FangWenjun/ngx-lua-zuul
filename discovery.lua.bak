local _M = {
    _VERSION="1.0",
    requestTimes=0,
    loadTime=os.date(),
    apps={},
    hosts={},

}

local http=require "resty.http"
-- https://github.com/pintsized/lua-resty-http
local json=require "cjson"
local url="http://127.0.0.1:8761/v1/apps"

--[[
    请求discovery，获取在线服务器列表
--]]
function _M:getAllApps()
    
    local httpc=http.new()
    httpc:set_timeout(1000)
    local res,err=httpc:request_uri(url,{
        method ="GET",
        headers = {
              ["Accept"] = "application/json",
          },

    })

    if not res then
        ngx.log(ngx.ERR,"failed to request :",err)
        return nil
    end
    local content=res.body
    -- local f=assert(loadstring("return " .. content))
    -- local  apps =  f()
    -- ngx.log(ngx.ERR, type(apps))
           
    --转换json字符串到lua table
    --[[
        json格式例子
        {
            "timestamp": 1452042891719,
            "apps": [
                {
                    "name": "GATEAWAY",
                    "hosts": [
                        {
                            "lastRenewalTimestamp": 1452042964223,
                            "hostName": "192.168.99.1",
                            "ip": "192.168.99.1",
                            "id": "192.168.99.1:gateaway",
                            "status": "UP",
                            "sport": null,
                            "name": "GATEAWAY",
                            "port": 8080
                        }
                    ]
                }
            ]
        }    
    --]]
    local apps = json.decode(content)
    self.apps=apps
    self.requestTimes=self.requestTimes+1
    if apps == nil then
        return content
    end

    --[[
        hosts格式：
        {
            "GATEAWAY": [
                "http://192.168.99.1:8080",
                "http://192.168.99.2:8080",
            ]
        }
    --]]

    for index,appList in pairs(apps.apps) do
        local x = 1
        self.hosts[appList.name]={}
        for k,v in pairs(appList.hosts) do
            if v.status=="UP" then
                self.hosts[v.name][x]="http://" .. v.hostName .. ":" .. v.port
                -- ngx.log(ngx.ERR, self.hosts[v.name][x])
                x=x+1
                
            end
        -- print(k,v.name)
        end
        -- print(index,appList.name)
    end
    



    -- ngx.log(ngx.ERR, type(apps))
        -- print(type(apps))

    ngx.log(ngx.ERR, "content=",content,", requestTimes: ",self.requestTimes)

    return content
end


--[[

启动定时任务，获取在线服务器列表

--]]
function _M:schedule()
 
    local shared = ngx.shared.apps
    local interval=1 

    function getAndSet(premature, shared ) 
        local content=_M:getAllApps()
        

        if content ~= nil then
            local succ, err, forcible = shared:set("apps", content) 
                ---ngx.log(ngx.ERR, "succ:", succ, " err:", err,"forcible",forcible)
        end
        local ok,err = ngx.timer.at(interval,getAndSet,shared)
        ngx.log(ngx.DEBUG, "ok:", ok, " err:", err)
    end
    
    local ok,err = ngx.timer.at(interval,getAndSet,shared)
    ngx.log(ngx.DEBUG, "ok:", ok, " err:", err)  

end


function _M:getHttpEndpont(path)
    local shared = ngx.shared.apps
    local apps =shared:get("apps")
    local uri = ngx.var.uri
    local first,last = string.find(uri,"/",2)
    local appName = string.upper(string.sub(s,0,first-1))
    local hosts=self.hosts[appName]
    shared:




               
    -- body

end
-- function _M.getHostByName(shared,name,balance)
--     local apps=shared:get("apps")
--     self.apps=
     
-- end

-- apps={
--     ["CALM_EDGE"]={
--         {
--             name="CALM_EDGE",
--             id= "192.168.99.1:calm_edge",
--             hostName="192.168.99.1",
--             ip="192.168.99.1",
--             port=8080,
--             sport=null,
--             status="UP",
--             lastRenewalTimestamp=1451030859398
 
--         }
--     }
-- }

return _M

-- {
--     "apps": [
--         {
--             "name": "CALM_EDGE",
--             "hosts": [
--                 {
--                     "name": "CALM_EDGE",
--                     "id": "192.168.99.1:calm_edge",
--                     "hostName": "192.168.99.1",
--                     "ip": "192.168.99.1",
--                     "port": 8080,
--                     "sport": null,
--                     "status": "UP",
--                     "lastRenewalTimestamp": 1451030859398
--                 }
--             ]
--         }
--     ],
--     "timestamp": 1451030794105
-- }
                -- local http=require "resty.http"
                -- local httpc=http.new()
                -- httpc:set_timeout(1000)
                -- local res,err=httpc:request_uri("http://127.0.0.1:8761/v1/apps",{
                --     method ="GET"
                -- })

                -- if not res then
                --     ngx.say("failed to request :",err)
                --     return
                -- end
                -- local content=res.body
                -- ngx.log(ngx.ERR,content)